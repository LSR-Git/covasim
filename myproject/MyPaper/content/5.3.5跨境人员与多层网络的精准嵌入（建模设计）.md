# 5.3.5 跨境人员与多层网络的精准嵌入（建模设计）

## 一、问题背景与建模难点

在第四章的单层模型中，跨境人员（候鸟）的移动逻辑相对简单：他们离开A区后，随机连接到B区的整个大网络中。进入第五章后，B区被拆分为家庭、社区、学校、工作四个平行的切片（层）。若跨境人员依然盲目且随机地连接，会出现反直觉的现象，例如A区跨境务工人员莫名其妙地连接到B区的家庭层或学校层。

为满足模型在定量分析上的严谨性和现实逼真度，需将跨境人员的移动逻辑从区域到区域的宏观跳转升级为基于出行目的的跨层精准嵌入。

---

## 二、三维度定量逻辑

### 1. 原属地网络层的权重冻结（Deactivation）

当候鸟节点 $i$ 在时间步 $t$ 离开A区时，其并非从系统中消失，而是其在A区各层（家庭、社区、学校、工作）中的接触边暂时失效。可通过将涉及该节点的边权重置零实现，回国后恢复。

### 2. 基于出行目的的目标层映射（Target Layer Mapping）

跨境人员进入B区后，应根据其跨境动机只接入特定的网络层。对候鸟集设定概率分布或标签分类，进行定量划分：

| 跨境类型 | 比例 | 目标层映射 | 说明 |
|---------|------|-----------|------|
| 跨境务工/商贸 | 高 | B区工作层 + 社区层 | 在工作场所产生固定接触，在街道/市场产生随机接触；不接入家庭层和学校层 |
| 跨境探亲 | 低 | B区家庭层 + 社区层 | 在亲友家庭及社区产生接触 |
| 偷渡者/隐匿流动 | 特殊 | B区社区层（100%） | 躲避筛查，不进入正规工作或学校网络；模拟地下市场或公共无序空间的随机接触 |

### 3. 目标地的跨区边静态预建与权重控制（Static Cross Layers + Beta Control）

鉴于 Covasim 的接触层在初始化时静态构建、传播计算时通过边权重（beta）控制参与度，采用静态预建跨区层而非每步动态生成边更为稳妥。确定目标层后，在人口初始化阶段为候鸟预建与B区各目标层的跨区边；引入层级接触权重系数 $\alpha_L$，定量控制跨境者在不同层的交互强度。跨境时通过将对应跨区层的 beta 置满、非目标层 beta 置零实现精准嵌入；回国时所有跨区层 beta 置零。该方式与现有 CrosserTravel 的 beta 控制逻辑一致，无需依赖动态增删边。

---

## 三、实现路径分析：改动现有代码 vs 新增函数

### 现有架构概览

- **CrossNetwork.add_cross_layer**：静态创建 cross 层，候鸟与B区人员随机连边（不区分层）
- **CrosserTravel**：每日出境/回国逻辑；按 position 将 base 层涉及跨境者的边 beta 置 0，cross 层边 beta 置满
- **第四章**：base（单层）+ cross 两层结构

### 推荐方案：新增函数与类，保留第四章逻辑

| 考量 | 改动现有 | 新增函数 |
|------|----------|----------|
| 第四章兼容性 | 需大量 if/else 分支，易引入回归 | 第四章逻辑完全不动 |
| 代码可读性 | 单文件臃肿，职责混杂 | 职责清晰，多层逻辑独立 |
| 测试与维护 | 需同时验证两种模式 | 可分别测试、独立演进 |
| 复用性 | 难以在第四章脚本中复用 | 第四章用原模块，第五章用新模块 |

**结论**：采用新增函数与类的方式，在保留 CrossNetwork、CrosserTravel 不变的前提下，为第五章新增多层专用逻辑。

**为何采用静态跨区层而非动态边**：Covasim 虽提供 Layer.append 与 pop_inds 用于增删边，但动态边需每步维护索引、与 dynam_layer 机制可能冲突，且实现与维护成本较高。现有 CrosserTravel 已通过静态边 + beta 控制实现跨境逻辑，沿用该方式可保持架构一致且无需依赖动态边。

### 建议新增模块与职责

| 模块/类 | 职责 |
|---------|------|
| CrossNetworkMultilayer | add_cross_layer_multilayer：为候鸟打标签（务工/探亲/偷渡）；按目标层映射预建 cross_work、cross_community、cross_home 等静态跨区层，边为候鸟与B区对应层人员的随机连接 |
| CrosserTravelMultilayer | 继承或仿照 CrosserTravel：实现（1）原属地各层权重冻结；（2）出境时按候鸟标签将对应跨区层 beta 置满、非目标层 beta 置零；（3）回国时所有跨区层 beta 置零、恢复A区边 |

### 技术要点

1. **权重冻结**：与现有 CrosserTravel 类似，对 A 区各层（h, s, w, c）中涉及出境候鸟的边，将 beta 置 0；回国后恢复。
2. **静态跨区层**：在 add_cross_layer_multilayer 阶段预建 cross_work（务工候鸟↔B区工作层人员）、cross_community（所有候鸟↔B区社区层人员）、cross_home（探亲候鸟↔B区家庭层人员）；偷渡者仅连 cross_community。边在初始化时一次性生成，不随跨境动态增删。
3. **按标签控制 beta**：出境时，务工候鸟的 cross_work 与 cross_community 有效、cross_home 无效；探亲候鸟的 cross_home 与 cross_community 有效、cross_work 无效；偷渡者仅 cross_community 有效。
4. **偷渡者**：可沿用 InjectUndocumentedInfectious 的 undocumented 标记，在目标层映射时偷渡者仅连 cross_community，且可配置为不参与检测/隔离的 subtarget 排除逻辑。
